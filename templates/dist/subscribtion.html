<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Web3 Jobs Bot</title>
    <meta name="theme-color" content="#ffffff " />
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.min.css" />
    <script src="./js/script.min.js" defer></script>
  </head>
  <body>
    <div class="wrapper">



      <main class="main">
        <div class="main__inner">
          <section class="subscribtion">
            <div class="subscribtion__img">
              <img src="./icons/win-icon.png" alt="win-icon" />
            </div>
            <h2 class="title">
              Pay <span>$20</span> a month for a tool that will help you find a <span>$100k</span> a
              year job!
            </h2>
            <ul class="subscribtion__list">
              <li class="subscribtion__list--item">
                <div class="subscribtion__list--img">
                  <img src="./icons/check-icon.svg" alt="check-icon" />
                </div>
                <p>The most comprehensive job database in the Web3 space</p>
              </li>
              <li class="subscribtion__list--item">
                <div class="subscribtion__list--img">
                  <img src="./icons/check-icon.svg" alt="check-icon" />
                </div>
                <p>Notifications when new jobs become available</p>
              </li>
              <li class="subscribtion__list--item">
                <div class="subscribtion__list--img">
                  <img src="./icons/check-icon.svg" alt="check-icon" />
                </div>
                <p>Get an edge over other candidates</p>
              </li>
            </ul>
            <div class="subscribtion__select">
              <div class="subscribtion__select--option active">
                <div class="subscribtion__select--left">
                  <p>1 month subscription</p>
                </div>
                <div class="subscribtion__select--price">$20/month</div>
              </div>
              <div class="subscribtion__select--option">
                <div class="subscribtion__select--left">
                  <p>1 year subscription</p>
                  <span>Save $40</span>
                </div>
                <div class="subscribtion__select--price">$200/year</div>
              </div>
            </div>
          </section>
        </div>
      </main>

      <a href="#" class="btn">Loading...</a>

    </div>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

     <script>
 document.addEventListener("DOMContentLoaded", async function () {
  const subscriptionOptions = document.querySelectorAll(".subscribtion__select--option");
  const buyButton = document.querySelector(".btn");
  const paymentLinkEndpoint = "/create_payment";
  let tg = window.Telegram.WebApp;
  tg.expand();
  let telegramId = tg.initDataUnsafe.user.id;

  async function open_subscribtion() {
      try {
        const response = await fetch(`https://web3jobs.online/open_subscribtion?telegram_id=${telegramId}`);
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }
  await open_subscribtion();

  // Функция для создания платежа на сервере
  const createPayment = async (telegramId, amount) => {
    try {
      const response = await fetch(paymentLinkEndpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          telegram_id: telegramId,
          amount: amount,
        }),
      });
      if (!response.ok) {
        throw new Error("Failed to create payment");
      }
      const data = await response.json();
      return data.payment_link;
    } catch (error) {
      console.error("Error creating payment:", error.message);
      return null;
    }
  };

  // Функция для установки активного пункта подписки при загрузке страницы
  const setInitialSubscription = async () => {
    // Получаем активный пункт подписки при загрузке страницы
    const activeOption = document.querySelector(".subscribtion__select--option.active");
    if (activeOption) {
      // Получаем сумму и текст для кнопки
      const priceText = activeOption.querySelector(".subscribtion__select--price").textContent.trim();
      const price = parseInt(priceText.replace(/\D/g, ''), 10); // Извлекаем числовую часть текста

      // Создаем платеж
      const paymentLink = await createPayment(telegramId, price);

      if (paymentLink) {
        // Устанавливаем текст кнопки и ссылку
        buyButton.textContent = `Buy for ${priceText}`;
        buyButton.href = paymentLink;
      } else {
        console.error("Payment link is null");
      }
    }
  };

  // Вызываем функцию для установки активного пункта подписки при загрузке страницы
  await setInitialSubscription();

  // Обработчик для кнопок выбора опции подписки
  subscriptionOptions.forEach((option) => {
    option.addEventListener("click", async function () {
      // Убираем активный класс у всех опций
      subscriptionOptions.forEach((opt) => opt.classList.remove("active"));
      // Добавляем активный класс к текущей опции
      this.classList.add("active");

      // Получаем сумму и текст для кнопки
      const priceText = this.querySelector(".subscribtion__select--price").textContent.trim();
      const price = parseInt(priceText.replace(/\D/g, ''), 10); // Извлекаем числовую часть текста
      buyButton.textContent = `Loading...`;


      // Создаем платеж
      const paymentLink = await createPayment(telegramId, price);

      if (paymentLink) {
        // Устанавливаем текст кнопки и ссылку
        buyButton.textContent = `Buy for ${priceText}`;
        buyButton.href = paymentLink;
      } else {
        console.error("Payment link is null");
      }
    });
  });
});


          </script>
  </body>
</html>
